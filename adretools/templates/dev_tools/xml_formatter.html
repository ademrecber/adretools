{% extends 'base.html' %}
{% load i18n %}

{% block title %}XML Formatter - AdreTools{% endblock %}

{% block content %}
<div class="container py-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'core:home' %}">{% trans "Home" %}</a></li>
            <li class="breadcrumb-item"><a href="{% url 'dev_tools:home' %}">{% trans "Developer Tools" %}</a></li>
            <li class="breadcrumb-item active">XML Formatter</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-12">
            <h1 class="h2 mb-3">XML Formatter & Viewer</h1>
            <p class="text-muted mb-4">Format, validate and visualize XML data with syntax highlighting</p>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">XML Input</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="xmlFile" class="form-label">Upload XML File</label>
                        <input type="file" class="form-control" id="xmlFile" accept=".xml">
                    </div>
                    <div class="mb-3">
                        <label for="xmlInput" class="form-label">Or paste XML content</label>
                        <textarea class="form-control" id="xmlInput" rows="15" placeholder="Paste your XML here..."></textarea>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-primary" onclick="formatXML()">Format</button>
                        <button type="button" class="btn btn-success" onclick="validateXML()">Validate</button>
                        <button type="button" class="btn btn-info" onclick="minifyXML()">Minify</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Formatted XML</h5>
                    <div>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="copyResult()">Copy</button>
                        <button type="button" class="btn btn-sm btn-outline-success" onclick="downloadHTML()">Download HTML</button>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="downloadPDF()">Download PDF</button>
                    </div>
                </div>
                <div class="card-body">
                    <pre id="xmlOutput" class="bg-light p-3 rounded" style="height: 400px; overflow-y: auto;"></pre>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Visual Preview</h5>
                </div>
                <div class="card-body">
                    <div id="xmlPreview" class="border rounded p-3" style="min-height: 200px; background: #f8f9fa;">
                        <p class="text-muted text-center">Formatted XML will appear here as a visual tree</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// File upload handler
document.getElementById('xmlFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('xmlInput').value = e.target.result;
        };
        reader.readAsText(file);
    }
});

function formatXML() {
    const input = document.getElementById('xmlInput').value.trim();
    if (!input) {
        alert('Please enter XML content!');
        return;
    }

    try {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(input, 'text/xml');
        
        // Check for parsing errors
        const parseError = xmlDoc.getElementsByTagName('parsererror');
        if (parseError.length > 0) {
            throw new Error('Invalid XML format');
        }

        const formatted = formatXMLString(input);
        document.getElementById('xmlOutput').innerHTML = syntaxHighlight(formatted);
        createVisualPreview(xmlDoc);
        
    } catch (error) {
        document.getElementById('xmlOutput').innerHTML = `<span class="text-danger">Error: ${error.message}</span>`;
    }
}

function validateXML() {
    const input = document.getElementById('xmlInput').value.trim();
    if (!input) {
        alert('Please enter XML content!');
        return;
    }

    try {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(input, 'text/xml');
        
        const parseError = xmlDoc.getElementsByTagName('parsererror');
        if (parseError.length > 0) {
            document.getElementById('xmlOutput').innerHTML = '<span class="text-danger">❌ Invalid XML</span>';
        } else {
            document.getElementById('xmlOutput').innerHTML = '<span class="text-success">✅ Valid XML</span>';
        }
    } catch (error) {
        document.getElementById('xmlOutput').innerHTML = `<span class="text-danger">❌ Error: ${error.message}</span>`;
    }
}

function minifyXML() {
    const input = document.getElementById('xmlInput').value.trim();
    if (!input) {
        alert('Please enter XML content!');
        return;
    }

    try {
        const minified = input.replace(/>\s+</g, '><').replace(/\s+/g, ' ').trim();
        document.getElementById('xmlOutput').textContent = minified;
    } catch (error) {
        document.getElementById('xmlOutput').innerHTML = `<span class="text-danger">Error: ${error.message}</span>`;
    }
}

function formatXMLString(xml) {
    const PADDING = ' '.repeat(2);
    const reg = /(>)(<)(\/*)/g;
    let pad = 0;

    xml = xml.replace(reg, '$1\r\n$2$3');

    return xml.split('\r\n').map((node, index) => {
        let indent = 0;
        if (node.match(/.+<\/\w[^>]*>$/)) {
            indent = 0;
        } else if (node.match(/^<\/\w/) && pad > 0) {
            pad -= 1;
        } else if (node.match(/^<\w[^>]*[^\/]>.*$/)) {
            indent = 1;
        } else {
            indent = 0;
        }

        const padding = PADDING.repeat(pad);
        pad += indent;

        return padding + node;
    }).join('\r\n');
}

function syntaxHighlight(xml) {
    return xml
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/(".*?")/g, '<span style="color: #d14;">$1</span>')
        .replace(/(&lt;\/?)([\w-]+)/g, '$1<span style="color: #0086b3;">$2</span>')
        .replace(/([\w-]+)=/g, '<span style="color: #795da3;">$1</span>=');
}

function createVisualPreview(xmlDoc) {
    const preview = document.getElementById('xmlPreview');
    preview.innerHTML = '';
    
    function createTreeNode(element, level = 0) {
        const div = document.createElement('div');
        div.style.marginLeft = (level * 20) + 'px';
        div.style.marginBottom = '5px';
        
        if (element.nodeType === 1) { // Element node
            const tagName = element.tagName;
            const attributes = Array.from(element.attributes).map(attr => 
                `${attr.name}="${attr.value}"`
            ).join(' ');
            
            div.innerHTML = `
                <span style="color: #0086b3; font-weight: bold;">&lt;${tagName}</span>
                ${attributes ? `<span style="color: #795da3;"> ${attributes}</span>` : ''}
                <span style="color: #0086b3; font-weight: bold;">&gt;</span>
            `;
            
            if (element.textContent.trim() && element.children.length === 0) {
                div.innerHTML += `<span style="color: #333;">${element.textContent.trim()}</span>`;
            }
            
            preview.appendChild(div);
            
            // Add children
            Array.from(element.children).forEach(child => {
                createTreeNode(child, level + 1);
            });
            
            if (element.children.length > 0) {
                const closeDiv = document.createElement('div');
                closeDiv.style.marginLeft = (level * 20) + 'px';
                closeDiv.innerHTML = `<span style="color: #0086b3; font-weight: bold;">&lt;/${tagName}&gt;</span>`;
                preview.appendChild(closeDiv);
            }
        }
    }
    
    if (xmlDoc.documentElement) {
        createTreeNode(xmlDoc.documentElement);
    }
}

function copyResult() {
    const output = document.getElementById('xmlOutput').textContent;
    navigator.clipboard.writeText(output).then(() => {
        alert('Copied to clipboard!');
    });
}

function downloadHTML() {
    const xmlContent = document.getElementById('xmlOutput').innerHTML;
    const html = `
<!DOCTYPE html>
<html>
<head>
    <title>XML Formatted Output</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>XML Formatted Output</h1>
    <pre>${xmlContent}</pre>
</body>
</html>`;
    
    const blob = new Blob([html], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'formatted-xml.html';
    a.click();
    URL.revokeObjectURL(url);
}

function downloadPDF() {
    // Simple PDF generation using browser print
    const xmlContent = document.getElementById('xmlOutput').textContent;
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
        <head>
            <title>XML Output</title>
            <style>
                body { font-family: monospace; margin: 20px; }
                pre { white-space: pre-wrap; word-wrap: break-word; }
            </style>
        </head>
        <body>
            <h1>XML Formatted Output</h1>
            <pre>${xmlContent}</pre>
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}
</script>
{% endblock %}